---
title: 如何保障一场大促(一)--系统演练
date: 2021-06-03 15:26:32
cover: https://gitee.com/dongzl/article-images/raw/master/cover/calcite_study.png
# author information, multiple authors are set to array
# single author
author:
  - nick: 董宗磊
    link: https://www.github.com/dongzl

# post subtitle in your index page
subtitle: 本文是本人所在京东某基础部门为保障周年日大促活动顺利进行所做的一些工作记录。

categories: 
  - 其他

tags: 
  - 大促
---

## 背景介绍

本人所在京东某基础部门工作，电商大交易平台的基础部门（可以理解是：基础用户、交易订单、商品信息、库存这几个黄金流程中的一个），618是京东周年庆会有大促活动，相比双11来说，618的大促活动对于京东会更重要一些，从4月底开始我们就需要为618大促做一些准备工作了，按时间说来从4月底到618时间还挺长的，是不是有点早，其实不是这样的，618的周年庆是从6月1日就开始的，中间去除五一假期、周末休息，其实时间并不多。

最近的几篇文章就是仔细记录一下我们为了保障一场大促顺利进行会进行的一些保障工作，可能会分几篇来说，这是第一篇，主要说说系统演练的工作。

系统演练内容主要是针对大促期间容易出现的线上系统问题进行人为模拟，在模拟出现问题之后需要系统研发人员快速定位问题出现原因，借助工具及时排除系统问题，保障系统服务稳定。对于我们演练采用红蓝对抗的方式进行，由蓝队人员故意制造一些破坏性事件，考察红军针对故障的应急能力。

## 权限梳理

虽然现在所在的部门是京东的核心部门，但是也不是所有的内容都是自己搞，很多基础服务还是要依赖于很多兄弟部门的；比如用数据库、redis、微服务等等基础功能，这些部门不仅会提供一些基础服务，针对这些基础服务也会开发运维管理系统，方便研发人员查询一些基本信息，定位一些简单问题。

那么问题来了，演练中排查一些故障是需要借助这些系统的，首先我们要确保参与演练的人员针对这些系统有对应的权限，不能出现因没有权限操作而不能排查问题尴尬问题，作为演练的一部分内容，梳理、开通系统权限，也是对大促重要保障。

### 系统权限

- 应用系统权限 -- 知道自己负责系统功能

- 系统代码权限 -- 定位问题可能也需要源代码

- 微服务系统权限

- 数据库权限、数据库运维系统权限

- 线上配置管理系统权限

... ... 其他系统权限等等

### 系统使用

系统是有了，权限也开通了，但是不一定研发就会借助系统定位问题、排除故障了。所以对于相关系统还要梳理排除故障的功能点使用手册，比如：

- 微服务的 provider 机器故障了，微服务系统如何摘除故障机器 provider；

- web 系统机器故障了，如何从域名对应的 VIP 中摘除故障机器。

系统功能要使用熟练，不能到演练时候再学习（也就是说不能到大促出现故障了再学习这个功能怎么用）。

## 系统监控

系统演练是为了及时发现故障、排查故障，发现是第一步、然后才是排除，如果都不能发现问题，也是谈不上排除了。快速发现问题就很关键了，最 Low 的发现问题方式是什么，就是等着用户反馈，系统大面积故障了，用户无法下单了，无法支付了，客服电话被打爆了，然后层层传递到研发小哥哥，最终上头条了。所以为了能及时发现系统故障，就需要对系统有360°全方位的监控。

对于京东系统监控分成两个层面：

- 服务器（容器）监控，也就是硬件资源监控；

- 应用系统层面监控。

### 服务器监控

服务器层面监控主要分成如下一些内容：

当然这里展示出的指标是我们比较关心、也是服务器容易出现故障的一些指标，具体到其它指标项还有很多，这里算是给服务器装上监控。

### 应用系统监控

对于应用系统本身的监控，京东内部是采用在应用系统代码中埋点的方式完成的，埋点产生的日志数据会写到服务器磁盘文件，然后后台进程将日志数据上报的专门的平台进行分成，生成对应业务代码的监控指标数据：比如 TP99、TP999、可用率等等，类似的代码逻辑如下：

```java
//埋点参数
CallerInfo callerInfo = Profiler.registerInfo(String key, String appName, boolean enableHeartbeat, boolean enableTP);
try {
//业务逻辑处理
} catch (Exception e) {
    //异常数据
    Profiler.functionError(callerInfo);
} finally {
    //结束埋点
    Profiler.registerInfoEnd(callerInfo);
}
```

上述这段代码是针对某个应用系统（appName）的某个指定业务 Key 进行埋点，key 是自定义的，通过这段埋点代码能够收集数据包括：

- 业务逻辑执行时间，能够计算业务逻辑执行 TP99、TP999、AVG、MAX 一些数据指标数据；

- 计算业务逻辑代码可用率（代码执行成功率），catch 捕获到了异常，意味着执行失败一次。

针对上面收集到的这些指标数据，我们就可以设置告警规则了，比如针对业务代码可用率，可以设置告警规则：`当方法可用率连续 2 次小于 99.9% 则报警，并在 15 分钟内只报一次警`，这样当这个 Key 上面的埋点上报数据触发我们设置的告警规则，那么就能够及时通知到相关系统负责人。

看了上面的示例其实有一点很重要，这段埋点代码是需要内置到系统业务逻辑代码中的，也就是在做业务逻辑开发的时候就要有意识的添加埋点代码，如果没有添加埋点代码，那系统就等于裸奔了，大促来临之际也就抓瞎了。

PS. 上面的代码懂开发的朋友不要喷：“你这是赤裸裸的代码入侵啊，都是重复模板代码，真垃圾“。我们就是要说清楚这个意思，不过京东确实这么搞的，已经有很多年历史了，大家都乐此不疲。

对于监控这里我只是大概描述一下，具体告警规则配置，我会有单独的文章在详细说，这里需要重点说明的是一定要有监控，否则系统就是在裸奔，研发就是睁眼瞎。

其实我们进行系统演练到底演练什么：说白了就是在应用出现故障的时候能够及时触发报警的规则，给出告警，研发在收到告警之后能够快速定位问题，排除故障。

## 演练告知

虽然是系统演练，是人为制造一些故障，但是演练的环境都是用的线上正式环境，正式环境是有很多下游调用方的，也许在演练的过程中某台机器的故障导致下游接口调用超时。

所以一方面演练要在业务调用量低估时间进行，另外一点也要提前给出公告，告诉下游正在搞破坏，出现问题不要紧张，如果有演练对下游业务影响严重需要停止演练，能够及时联系到负责人。

```
大家好，集团xxx团队 -- xxx系统进行捣乱测试和应急响应演练：

时间：5月12日00:30 - 5月12日 07:00 ；

范围：覆盖xxx、xxx、xxx、xxx四个站点xxx服务，演练场景包含xxx、xxx、xxx、xxx、xxx等；

影响：演练期间会对线上xxx系统服务有短暂影响，单个演练case影响不超过5分钟

请各相关业务研发团队及时关注各自系统稳定性，如遇到xxx依赖相关异常和问题，请及时与xxx团队联系：张三（13838383838）、李四（18686868686）
```

## 梳理演练场景

