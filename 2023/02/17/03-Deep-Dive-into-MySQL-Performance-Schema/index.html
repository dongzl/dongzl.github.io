<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><title>深入探究 MySQL 数据库 Performance Schema | 董宗磊的博客--靡不有初，鲜克有终</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="[object Object]"><meta name="designer" content="minfive"><meta name="keywords" content="程序员, java, web, 数据库, 架构, 设计模式, 数据结构, 算法"><meta name="description" content="记录自己作为程序员的技术成长经历，程序员是个特殊的职业，一旦选择这个职业就要时刻保持学习的热情，如果你也喜欢我的博客，欢迎订阅 RSS。"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="https://dongzl.github.io/2023/02/17/03-Deep-Dive-into-MySQL-Performance-Schema/index.html"><link rel="icon" type="image/png" href="/img/theme/favicon.ico" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="董宗磊的博客" type="application/atom+xml"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?e4027971a230b210f4671f485b33846a",document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)}()</script><link rel="stylesheet" href="/scss/views/page/post.css"><meta name="generator" content="Hexo 7.0.0"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/img/theme/loading.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="董宗磊的博客" alt="董宗磊的博客"><img src="/img/theme/title.png" alt="董宗磊的博客"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a target="_blank" rel="noopener" href="https://course.rs/about-book.html" alt="Rust" title="Rust">Rust</a></li><li class="nav__item"><a href="https://dongzl.github.io/netty-handbook/" alt="Netty" title="Netty">Netty</a></li><li class="nav__item"><a href="/2019/01/01/01-Excellent-Article-Link/" alt="好文链接" title="好文链接">好文链接</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="https://cdn.jsdelivr.net/gh/dongzl/dongzl.github.io@hexo/source/images/cover/mysql_study.png" alt="深入探究 MySQL 数据库 Performance Schema"></div><header class="post__info"><h1 class="post__title">深入探究 MySQL 数据库 Performance Schema</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a target="_blank" rel="noopener" href="https://www.percona.com/blog/author/ankit-kapoor/">Ankit Kapoor</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2023-02-17</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/MySQL/">MySQL</a></li><li class="mark__item"><a href="/tags/Performance-Schema/">Performance Schema</a></li></ul></div></div></header><div class="post__content"><blockquote><p>原文链接：<a target="_blank" rel="noopener" href="https://www.percona.com/blog/deep-dive-into-mysqls-performance-schema/">https://www.percona.com/blog/deep-dive-into-mysqls-performance-schema/</a></p></blockquote><p>最近我正在与一位客户合作，我们工作的重点是对客户的多个 <code>MySQL</code> 数据库节点进行性能审计。我们开始研究 <code>performance schema</code> 的一些统计数据。在工作中客户提出了两个有趣的问题：如何才能充分利用 <code>performance schema</code>，如何能够找到所需要的内容？我意识到理解 <code>performance schema</code> 的内部实现，并知道如何有效地利用它是非常重要的。这个博客的目的是让每个人都能够更容易理解 <code>performance schema</code>。</p><p><code>performance schema</code> 是 <code>MySQL</code> 中的一个引擎，我们可以使用 <code>SHOW ENGINES</code> 很方便查看它是否已被启用。它完全建立在各种的 <code>Instrument</code> 集合（也可以称为事件名称）之上，这些 <code>Instrument</code> 集合分别服务于不同的目的。</p><p><code>Instrument</code> 是 <code>performance schema</code> 的主要组成部分，当我们想排查一个问题及其出现的根本原因时，它非常有用；下面我列出了一些示例（但不限于如下内容）：</p><ul><li><strong>1、哪个 <code>IO</code> 操作导致 <code>MySQL</code> 变慢？</strong></li><li><strong>2、进程/线程主要在等待哪个文件？</strong></li><li><strong>3、查询在每个执行阶段需要花费时间，或者 <code>alter</code> 命令将花费多少时间？</strong></li><li><strong>4、哪个进程消耗了大部分内存或如何确定内存泄漏的原因？</strong></li></ul><blockquote><ol><li>Which IO operation is causing MySQL to slow down?</li><li>Which file a process/thread is mostly waiting for?</li><li>At which execution stage is a query taking time, or how much time will an alter command will take?</li><li>Which process is consuming most of the memory or how to identify the cause of memory leakage?</li></ol></blockquote><h3 id="Instrument-在-performance-schema-中的作用"><a href="#Instrument-在-performance-schema-中的作用" class="headerlink" title="Instrument 在 performance schema 中的作用"></a>Instrument 在 performance schema 中的作用</h3><p><code>Instrument</code> 是将 <strong>wait</strong>、<strong>IO</strong>、<strong>SQL</strong>、<strong>binlog</strong>、<strong>file</strong> 等不同组件组合到一起。如果我们将这些组件组合起来，它们将成为帮助我们解决不同问题的非常有用的工具。例如，<strong>wait/io/file/sql/binlog</strong> 是提供二进制日志文件阻塞等待和 <code>I/O</code> 详细信息的工具之一。<code>Instrument</code> 从左边读取，组件之间使用“/”分隔符进行分割。我们添加到 <code>Instrument</code> 中的组件越多，它就会变得越复杂、越具体，即 <code>Instrument</code> 越长，它就越复杂。</p><p>我们可以在所使用的 <code>MySQL</code> 版本 <code>setup_instruments</code> 表中找到所有可用的 <code>Instrument</code>。值得注意的是，每个版本的 <code>MySQL</code> 都有不同数量的 <code>Instrument</code>。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">from</span> performance_schema.setup_instruments;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="number">1</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">1269</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br></pre></td></tr></table></figure><p>为了便于理解，<code>Instrument</code> 可以分为如下所示的七个不同的部分。<strong>我这里使用的 <code>MySQL</code> 版本是 <code>8.0.30</code></strong>。在早期版本中，我们只能使用其中四个部分，因此如果使用不同或者较低的 <code>MySQL</code> 版本，我们可能会看到不同类型的 <code>Instrument</code>。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span>(substring_index(name,<span class="string">&#x27;/&#x27;</span>,<span class="number">1</span>)) <span class="keyword">from</span> performance_schema.setup_instruments;</span><br><span class="line"> </span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+</span></span><br><span class="line"><span class="operator">|</span> (substring_index(name,<span class="string">&#x27;/&#x27;</span>,<span class="number">1</span>)) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+</span></span><br><span class="line"><span class="operator">|</span> wait                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> idle                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stage                         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> statement                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> transaction                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> memory                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> error                         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+</span></span><br><span class="line"> </span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>Stage</strong> - 以 <code>stage</code> 开头的 <code>Instrument</code> 提供所有查询所处执行阶段信息，如读取数据、发送数据、修改表、检查查询缓存等等。例如 <code>stage/sql/altering table</code>；</li><li><strong>Wait</strong> - 以 <code>wait</code> 开头的 <code>Instrument</code> 放在这里，像互斥锁等待、文件等待、<code>I/O</code> 等待和表等待。这个 <code>Instrument</code> 的一个示例 <strong>wait/io/file/sql/map</strong>；</li><li><strong>Memory</strong> - 以 <code>memory</code> 开头的 <code>Instrument</code> 提供有关每个线程内存使用情况的信息，例如 <strong>memory/sql/MYSQL_BIN_LOG</strong>；</li><li><strong>Statement</strong> - 以 <code>statement</code> 开头的 <code>Instrument</code> 提供有关 <code>SQL</code> 类型和存储过程的信息；</li><li><strong>Idle</strong> - 提供有关套接字连接的信息和与连接相关线程的信息；</li><li><strong>Transaction</strong> - 提供与事务相关的信息并且只有一种 <code>Instrument</code>；</li><li><strong>Error</strong> - <code>Error</code> 只有一种 <code>Instrument</code>，它提供用户操作过程中产生的错误信息，该 <code>Instrument</code> 没有附加其他组件。</li></ul><p>下面列出了这七个组件的 <code>Instrument</code> 总数，我们可以仅以这些名称起始来识别这些 <code>Instrument</code>。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span>(substring_index(name,<span class="string">&#x27;/&#x27;</span>,<span class="number">1</span>)) <span class="keyword">as</span> instrument_name,<span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">from</span> performance_schema.setup_instruments <span class="keyword">group</span> <span class="keyword">by</span> instrument_name;</span><br><span class="line"> </span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+----------+</span></span><br><span class="line"><span class="operator">|</span> instrument_name <span class="operator">|</span> <span class="built_in">count</span>(<span class="number">1</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+----------+</span></span><br><span class="line"><span class="operator">|</span> wait            <span class="operator">|</span>      <span class="number">399</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> idle            <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stage           <span class="operator">|</span>      <span class="number">133</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> statement       <span class="operator">|</span>      <span class="number">221</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> transaction     <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> memory          <span class="operator">|</span>      <span class="number">513</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> error           <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+----------+</span></span><br></pre></td></tr></table></figure><h3 id="如何找到所需要的-Instrument"><a href="#如何找到所需要的-Instrument" class="headerlink" title="如何找到所需要的 Instrument"></a>如何找到所需要的 Instrument</h3><p>我清楚地记得有位客户问我，既然有成千上万种 <code>Instrument</code> 可供选择，他如何才能找到他需要的那一种。正如我之前提到的，<code>Instrument</code> 是从左到右阅读的，我们可以找出我们需要的 <code>Instrument</code>，然后找到它各自代表的性能指标。</p><p>例如，如果我们需要观察 <code>MySQL</code> 实例的 <code>redo</code> 日志（日志文件或 <code>WAL</code> 文件）的性能，需要检查线程/连接在写入数据之前，是否需要等待 <code>redo</code> 日志文件刷新到磁盘，如果需要等待，将会等待多长时间？</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> setup_instruments <span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;%innodb_log_file%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------+---------+-------+------------+------------+---------------+</span></span><br><span class="line"><span class="operator">|</span> NAME                                    <span class="operator">|</span> ENABLED <span class="operator">|</span> TIMED <span class="operator">|</span> PROPERTIES <span class="operator">|</span> VOLATILITY <span class="operator">|</span> DOCUMENTATION <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------+---------+-------+------------+------------+---------------+</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>synch<span class="operator">/</span>mutex<span class="operator">/</span>innodb<span class="operator">/</span>log_files_mutex <span class="operator">|</span> <span class="keyword">NO</span>      <span class="operator">|</span> <span class="keyword">NO</span>    <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span>innodb<span class="operator">/</span>innodb_log_file     <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------+---------+-------+------------+------------+---------------+</span></span><br></pre></td></tr></table></figure><p>在这里显示我有两个用于 <code>redo</code> 日志文件的工具。一个是关于 <code>redo</code> 日志文件的互斥锁统计信息，第二个是关于 <code>redo</code> 日志文件的 <code>IO</code> 等待统计信息。</p><p>示例二，我们需要找出可以计算花费时间的操作或工具，即批量更新需要多少时间。以下是所有可以帮助我们进行定位的 <code>Instrument</code>。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> setup_instruments <span class="keyword">where</span> PROPERTIES<span class="operator">=</span><span class="string">&#x27;progress&#x27;</span>;        </span><br><span class="line"> </span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------------------------------+---------+-------+------------+------------+---------------+</span></span><br><span class="line"><span class="operator">|</span> NAME                                                 <span class="operator">|</span> ENABLED <span class="operator">|</span> TIMED <span class="operator">|</span> PROPERTIES <span class="operator">|</span> VOLATILITY <span class="operator">|</span> DOCUMENTATION <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------------------------------+---------+-------+------------+------------+---------------+</span></span><br><span class="line"><span class="operator">|</span> stage<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span><span class="keyword">copy</span> <span class="keyword">to</span> tmp <span class="keyword">table</span>                          <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span> progress   <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stage<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>Applying batch <span class="keyword">of</span> <span class="type">row</span> changes (write)      <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span> progress   <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stage<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>Applying batch <span class="keyword">of</span> <span class="type">row</span> changes (<span class="keyword">update</span>)     <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span> progress   <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stage<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>Applying batch <span class="keyword">of</span> <span class="type">row</span> changes (<span class="keyword">delete</span>)     <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span> progress   <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stage<span class="operator">/</span>innodb<span class="operator">/</span><span class="keyword">alter</span> <span class="keyword">table</span> (<span class="keyword">end</span>)                       <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span> progress   <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stage<span class="operator">/</span>innodb<span class="operator">/</span><span class="keyword">alter</span> <span class="keyword">table</span> (flush)                     <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span> progress   <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stage<span class="operator">/</span>innodb<span class="operator">/</span><span class="keyword">alter</span> <span class="keyword">table</span> (<span class="keyword">insert</span>)                    <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span> progress   <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stage<span class="operator">/</span>innodb<span class="operator">/</span><span class="keyword">alter</span> <span class="keyword">table</span> (log apply index)           <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span> progress   <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stage<span class="operator">/</span>innodb<span class="operator">/</span><span class="keyword">alter</span> <span class="keyword">table</span> (log apply <span class="keyword">table</span>)           <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span> progress   <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stage<span class="operator">/</span>innodb<span class="operator">/</span><span class="keyword">alter</span> <span class="keyword">table</span> (<span class="keyword">merge</span> sort)                <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span> progress   <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stage<span class="operator">/</span>innodb<span class="operator">/</span><span class="keyword">alter</span> <span class="keyword">table</span> (read PK <span class="keyword">and</span> internal sort) <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span> progress   <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stage<span class="operator">/</span>innodb<span class="operator">/</span><span class="keyword">alter</span> <span class="keyword">table</span>space (encryption)           <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span> progress   <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stage<span class="operator">/</span>innodb<span class="operator">/</span>buffer pool load                        <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span> progress   <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stage<span class="operator">/</span>innodb<span class="operator">/</span>clone (file <span class="keyword">copy</span>)                       <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span> progress   <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stage<span class="operator">/</span>innodb<span class="operator">/</span>clone (redo <span class="keyword">copy</span>)                       <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span> progress   <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stage<span class="operator">/</span>innodb<span class="operator">/</span>clone (page <span class="keyword">copy</span>)                       <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span> progress   <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------------------------------+---------+-------+------------+------------+---------------+</span></span><br></pre></td></tr></table></figure><p>上述 <code>Instrument</code> 是可以进行跟踪定位的工具。</p><h3 id="如何准备-Instrument-来解决性能问题"><a href="#如何准备-Instrument-来解决性能问题" class="headerlink" title="如何准备 Instrument 来解决性能问题"></a>如何准备 Instrument 来解决性能问题</h3><p>要利用这些 <code>Instrument</code>，首先需要启用它们来收集 <code>performance schema</code> 日志相关数据。除了记录运行线程的信息外，还可以维护此类线程的历史记录（<code>statement</code> / <code>stages</code> 或任何特定操作）。我们查看一下默认情况下所使用版本的数据库中启用了多少 <code>Instrument</code>，我没有明确启用过任何 <code>Instrument</code>。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> setup_instruments <span class="keyword">where</span> ENABLED<span class="operator">=</span><span class="string">&#x27;YES&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">810</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>下面的查询列出了前 <code>30</code> 个启用的 <code>Instrument</code>，它们将在表中进行日志记录。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> performance_schema.setup_instruments <span class="keyword">where</span> enabled<span class="operator">=</span><span class="string">&#x27;YES&#x27;</span> limit <span class="number">30</span>;</span><br><span class="line"> </span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------+---------+-------+------------+------------+---------------+</span></span><br><span class="line"><span class="operator">|</span> NAME                                  <span class="operator">|</span> ENABLED <span class="operator">|</span> TIMED <span class="operator">|</span> PROPERTIES <span class="operator">|</span> VOLATILITY <span class="operator">|</span> DOCUMENTATION <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------+---------+-------+------------+------------+---------------+</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>binlog               <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>binlog_cache         <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>binlog_index         <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>binlog_index_cache   <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>relaylog             <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>relaylog_cache       <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>relaylog_index       <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>relaylog_index_cache <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>io_cache             <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>casetest             <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>dbopt                <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>ERRMSG               <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>select_to_file       <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>file_parser          <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>FRM                  <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>load                 <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>LOAD_FILE            <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>log_event_data       <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>log_event_info       <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>misc                 <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>pid                  <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>query_log            <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>slow_log             <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>tclog                <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>trigger_name         <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span><span class="keyword">trigger</span>              <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>init                 <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>SDI                  <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>hash_join            <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span>mysys<span class="operator">/</span>proc_meminfo       <span class="operator">|</span> YES     <span class="operator">|</span> YES   <span class="operator">|</span>            <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------+---------+-------+------------+------------+---------------+</span></span><br></pre></td></tr></table></figure><p>正如我之前提到的，还可以维护事件的历史记录。例如，如果我们正在进行负载测试并希望分析查询完成后的性能，则需要激活以下事件（如果尚未激活）。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> performance_schema.setup_consumers;</span><br><span class="line"> </span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+---------+</span></span><br><span class="line"><span class="operator">|</span> NAME                             <span class="operator">|</span> ENABLED <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+---------+</span></span><br><span class="line"><span class="operator">|</span> events_stages_current            <span class="operator">|</span> YES     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> events_stages_history            <span class="operator">|</span> YES     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> events_stages_history_long       <span class="operator">|</span> YES     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> events_statements_cpu            <span class="operator">|</span> YES     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> events_statements_current        <span class="operator">|</span> YES     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> events_statements_history        <span class="operator">|</span> YES     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> events_statements_history_long   <span class="operator">|</span> YES     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> events_transactions_current      <span class="operator">|</span> YES     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> events_transactions_history      <span class="operator">|</span> YES     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> events_transactions_history_long <span class="operator">|</span> YES     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> events_waits_current             <span class="operator">|</span> YES     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> events_waits_history             <span class="operator">|</span> YES     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> events_waits_history_long        <span class="operator">|</span> YES     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> global_instrumentation           <span class="operator">|</span> YES     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> thread_instrumentation           <span class="operator">|</span> YES     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> statements_digest                <span class="operator">|</span> YES     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+---------+</span></span><br></pre></td></tr></table></figure><p>注意：上面列出的前 <code>15</code> 条记录的意思是很明确的，但最后一条与摘要相关事件作用是允许记录 <code>SQL</code> 语句的摘要文本。我的意思是摘要内容，将相似的查询分组并显示它们的性能，这是通过哈希算法完成的。</p><p>比如说我们想分析在查询哪个阶段花费了大量的时间，我们需要使用以下语句启用相应的日志记录。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MySQL<span class="operator">&gt;</span> <span class="keyword">update</span> performance_schema.setup_consumers <span class="keyword">set</span> ENABLED<span class="operator">=</span><span class="string">&#x27;YES&#x27;</span> <span class="keyword">where</span> NAME<span class="operator">=</span><span class="string">&#x27;events_stages_current&#x27;</span>;</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">Rows</span> matched: <span class="number">1</span>  Changed: <span class="number">1</span>  Warnings: <span class="number">0</span></span><br></pre></td></tr></table></figure><h3 id="如何充分利用-performance-schema"><a href="#如何充分利用-performance-schema" class="headerlink" title="如何充分利用 performance schema"></a>如何充分利用 performance schema</h3><p>现在我们知道什么是 <code>Instrument</code>、如何启用它们以及我们要存储的数据量，是时候了解如何使用这些 <code>Instrument</code> 了。为了更容易理解，我从测试用例中提取了一些 <code>Instrument</code> 的输出，因为有超过一千种 <code>Instrument</code>，我们的测试不可能覆盖所有。</p><p>请注意为了生成模拟负载，我使用了 <code>sysbench</code>（如果不熟悉它，可以阅读<a target="_blank" rel="noopener" href="https://github.com/akopytov/sysbench">此处</a>文档）工具，它可以使用以下内容创建读写流量：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">lua : oltp_read_write.lua</span><br><span class="line"> </span><br><span class="line">Number of tables : <span class="number">1</span></span><br><span class="line"> </span><br><span class="line">table_Size : <span class="number">100000</span></span><br><span class="line"> </span><br><span class="line">threads : <span class="number">4</span>/<span class="number">10</span> </span><br><span class="line"> </span><br><span class="line">rate - <span class="number">10</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>举个例子，思考一下如果我们想知道内存被使用的情况，为了找出这一点，我们可以在与内存相关的表中执行以下查询。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> memory_summary_global_by_event_name <span class="keyword">order</span> <span class="keyword">by</span> SUM_NUMBER_OF_BYTES_ALLOC <span class="keyword">desc</span> limit <span class="number">3</span>\G;</span><br><span class="line"> </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">                  EVENT_NAME: memory<span class="operator">/</span>innodb<span class="operator">/</span>buf_buf_pool</span><br><span class="line">                 COUNT_ALLOC: <span class="number">24</span></span><br><span class="line">                  COUNT_FREE: <span class="number">0</span></span><br><span class="line">   SUM_NUMBER_OF_BYTES_ALLOC: <span class="number">3292102656</span></span><br><span class="line">    SUM_NUMBER_OF_BYTES_FREE: <span class="number">0</span></span><br><span class="line">              LOW_COUNT_USED: <span class="number">0</span></span><br><span class="line">          CURRENT_COUNT_USED: <span class="number">24</span></span><br><span class="line">             HIGH_COUNT_USED: <span class="number">24</span></span><br><span class="line">    LOW_NUMBER_OF_BYTES_USED: <span class="number">0</span></span><br><span class="line">CURRENT_NUMBER_OF_BYTES_USED: <span class="number">3292102656</span></span><br><span class="line">   HIGH_NUMBER_OF_BYTES_USED: <span class="number">3292102656</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">                  EVENT_NAME: memory<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>THD::main_mem_root</span><br><span class="line">                 COUNT_ALLOC: <span class="number">138566</span></span><br><span class="line">                  COUNT_FREE: <span class="number">138543</span></span><br><span class="line">   SUM_NUMBER_OF_BYTES_ALLOC: <span class="number">2444314336</span></span><br><span class="line">    SUM_NUMBER_OF_BYTES_FREE: <span class="number">2443662928</span></span><br><span class="line">              LOW_COUNT_USED: <span class="number">0</span></span><br><span class="line">          CURRENT_COUNT_USED: <span class="number">23</span></span><br><span class="line">             HIGH_COUNT_USED: <span class="number">98</span></span><br><span class="line">    LOW_NUMBER_OF_BYTES_USED: <span class="number">0</span></span><br><span class="line">CURRENT_NUMBER_OF_BYTES_USED: <span class="number">651408</span></span><br><span class="line">   HIGH_NUMBER_OF_BYTES_USED: <span class="number">4075056</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">3.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">                  EVENT_NAME: memory<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>Filesort_buffer::sort_keys</span><br><span class="line">                 COUNT_ALLOC: <span class="number">58869</span></span><br><span class="line">                  COUNT_FREE: <span class="number">58868</span></span><br><span class="line">   SUM_NUMBER_OF_BYTES_ALLOC: <span class="number">2412676319</span></span><br><span class="line">    SUM_NUMBER_OF_BYTES_FREE: <span class="number">2412673879</span></span><br><span class="line">              LOW_COUNT_USED: <span class="number">0</span></span><br><span class="line">          CURRENT_COUNT_USED: <span class="number">1</span></span><br><span class="line">             HIGH_COUNT_USED: <span class="number">13</span></span><br><span class="line">    LOW_NUMBER_OF_BYTES_USED: <span class="number">0</span></span><br><span class="line">CURRENT_NUMBER_OF_BYTES_USED: <span class="number">2440</span></span><br><span class="line">   HIGH_NUMBER_OF_BYTES_USED: <span class="number">491936</span></span><br><span class="line"> </span><br><span class="line">Above <span class="keyword">are</span> the top three records, showing <span class="keyword">where</span> the memory <span class="keyword">is</span> getting mostly utilized.</span><br></pre></td></tr></table></figure><p><code>memory/innodb/buf_buf_pool</code> 这个 <code>Instrument</code> 与缓冲池相关，我们可以从 <code>SUM_NUMBER_OF_BYTES_ALLOC</code> 字段了解到缓冲池被分配了 <code>3GB</code> 空间。另一个对我们来说也很重要的数据是 <code>CURRENT_COUNT_USED</code>，它告诉我们当前使用了多少数据块，一旦工作完成，该列的值将被修改。看这条记录的统计数据，<code>3GB</code> 的消耗不是问题，即使 <code>MySQL</code> 非常频繁地使用缓冲池（例如，写入数据、加载数据、修改数据等）。但是当我们遇到内存泄漏问题或缓冲池未被使用时，问题就来了，在这种情况下，该 <code>Instrument</code> 对分析问题非常有用。</p><p>再看第二个 <code>Instrument</code>，<code>memory/sql/THD::main_mem_root</code> 占用了 <code>2G</code> 空间，这个 <code>Instrument</code> 跟 <code>SQL</code> 相关（应该从最左边开始读）。<code>THD::main_mem_root</code> 是一种线程类型。让我们试着了解这个 <code>Instrument</code>：</p><p><strong>THD</strong> 代表线程</p><p><strong>main_mem_root</strong> 是 <code>MEM_ROOT</code> 的一种类型。 <code>MEM_ROOT</code> 是一种为线程分配内存空间的结构体，这些线程用于解析查询、生成执行计划期间、执行嵌套查询/子查询期间或者其他执行查询分配资源操作。现在，在我们的例子中我们想要查看 <strong>线程/主机</strong> 内存消耗情况，以便我们可以进一步优化查询。在进一步深入学习之前，让我们先了解第三种 <code>Instrument</code>，这是一种用于搜索的重要 <code>Instrument</code>。</p><p><strong>memory/sql/filesort_buffer::sort_keys</strong> —— 正如我之前提到的，<code>Instrument</code> 名称应该从左侧开始阅读。这是一个和 <code>SQL</code> 内存分配有关的 <code>Instrument</code>，该 <code>Instrument</code> 中的下一个组件是 <strong>filesort_buffer::sort_keys</strong>，它负责对数据进行排序（它可以是一个缓冲区，用于存储数据并进行排序，这方面的各种示例很多，比如索引创建或常见的 <code>order by</code> 子句）。</p><p>是时候深入分析哪个连接正在使用内存了。为了找出这一点，我使用了表 <strong>memory_summary_by_host_by_event_name</strong> 并过滤出来自我的应用程序服务器的记录。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> memory_summary_by_host_by_event_name <span class="keyword">where</span> HOST<span class="operator">=</span><span class="string">&#x27;10.11.120.141&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> SUM_NUMBER_OF_BYTES_ALLOC <span class="keyword">desc</span> limit <span class="number">2</span>\G;</span><br><span class="line"></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">                        HOST: <span class="number">10.11</span><span class="number">.120</span><span class="number">.141</span></span><br><span class="line">                  EVENT_NAME: memory<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>THD::main_mem_root</span><br><span class="line">                 COUNT_ALLOC: <span class="number">73817</span></span><br><span class="line">                  COUNT_FREE: <span class="number">73810</span></span><br><span class="line">   SUM_NUMBER_OF_BYTES_ALLOC: <span class="number">1300244144</span></span><br><span class="line">    SUM_NUMBER_OF_BYTES_FREE: <span class="number">1300114784</span></span><br><span class="line">              LOW_COUNT_USED: <span class="number">0</span></span><br><span class="line">          CURRENT_COUNT_USED: <span class="number">7</span></span><br><span class="line">             HIGH_COUNT_USED: <span class="number">39</span></span><br><span class="line">    LOW_NUMBER_OF_BYTES_USED: <span class="number">0</span></span><br><span class="line">CURRENT_NUMBER_OF_BYTES_USED: <span class="number">129360</span></span><br><span class="line">   HIGH_NUMBER_OF_BYTES_USED: <span class="number">667744</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">                        HOST: <span class="number">10.11</span><span class="number">.120</span><span class="number">.141</span></span><br><span class="line">                  EVENT_NAME: memory<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>Filesort_buffer::sort_keys</span><br><span class="line">                 COUNT_ALLOC: <span class="number">31318</span></span><br><span class="line">                  COUNT_FREE: <span class="number">31318</span></span><br><span class="line">   SUM_NUMBER_OF_BYTES_ALLOC: <span class="number">1283771072</span></span><br><span class="line">    SUM_NUMBER_OF_BYTES_FREE: <span class="number">1283771072</span></span><br><span class="line">              LOW_COUNT_USED: <span class="number">0</span></span><br><span class="line">          CURRENT_COUNT_USED: <span class="number">0</span></span><br><span class="line">             HIGH_COUNT_USED: <span class="number">8</span></span><br><span class="line">    LOW_NUMBER_OF_BYTES_USED: <span class="number">0</span></span><br><span class="line">CURRENT_NUMBER_OF_BYTES_USED: <span class="number">0</span></span><br><span class="line">   HIGH_NUMBER_OF_BYTES_USED: <span class="number">327936</span></span><br></pre></td></tr></table></figure><p>主机 <code>11.11.120.141</code> 是我执行查询的应用程序主机，通过事件 <strong>memory/sql/THD::main_mem_root</strong> 显示，这台主机已消耗超过 <code>1G</code> 内存（内存总和）。现在我们已经知道这台主机目前内存消耗情况，我们就可以进一步挖掘以找出嵌套查询或子查询之类的查询语句，然后尝试对其进行优化。</p><p>同样，如果我们看到在执行查询时 <strong>filesort_buffer::sort_keys</strong> 分配的内存也超过了1G（内存总和）。这些 <code>Instrument</code> 显示我们的查询语句可能是带有排序操作（例如：<code>order by</code> 子句）。</p><h4 id="是时候加入一些基线测试"><a href="#是时候加入一些基线测试" class="headerlink" title="是时候加入一些基线测试"></a>是时候加入一些基线测试</h4><p><strong>案例一</strong></p><p>我们尝试查找出在文件排序时占用大量内存这种情况下的罪魁祸首线程。第一个查询帮助我们找到主机和事件名称（<code>Instrument</code>）：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> memory_summary_by_host_by_event_name <span class="keyword">order</span> <span class="keyword">by</span> SUM_NUMBER_OF_BYTES_ALLOC <span class="keyword">desc</span> limit <span class="number">1</span>\G;</span><br><span class="line"> </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">                        HOST: <span class="number">10.11</span><span class="number">.54</span><span class="number">.152</span></span><br><span class="line">                  EVENT_NAME: memory<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>Filesort_buffer::sort_keys</span><br><span class="line">                 COUNT_ALLOC: <span class="number">5617297</span></span><br><span class="line">                  COUNT_FREE: <span class="number">5617297</span></span><br><span class="line">   SUM_NUMBER_OF_BYTES_ALLOC: <span class="number">193386762784</span></span><br><span class="line">    SUM_NUMBER_OF_BYTES_FREE: <span class="number">193386762784</span></span><br><span class="line">              LOW_COUNT_USED: <span class="number">0</span></span><br><span class="line">          CURRENT_COUNT_USED: <span class="number">0</span></span><br><span class="line">             HIGH_COUNT_USED: <span class="number">20</span></span><br><span class="line">    LOW_NUMBER_OF_BYTES_USED: <span class="number">0</span></span><br><span class="line">CURRENT_NUMBER_OF_BYTES_USED: <span class="number">0</span></span><br><span class="line">   HIGH_NUMBER_OF_BYTES_USED: <span class="number">819840</span></span><br></pre></td></tr></table></figure><p>这是我的应用程序主机，让我们找出正在执行的用户及其各自的线程 <code>ID</code>。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> memory_summary_by_account_by_event_name <span class="keyword">where</span> HOST<span class="operator">=</span><span class="string">&#x27;10.11.54.152&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> SUM_NUMBER_OF_BYTES_ALLOC <span class="keyword">desc</span> limit <span class="number">1</span>\G;</span><br><span class="line"></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">                        <span class="keyword">USER</span>: sbuser</span><br><span class="line">                        HOST: <span class="number">10.11</span><span class="number">.54</span><span class="number">.152</span></span><br><span class="line">                  EVENT_NAME: memory<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>Filesort_buffer::sort_keys</span><br><span class="line">                 COUNT_ALLOC: <span class="number">5612993</span></span><br><span class="line">                  COUNT_FREE: <span class="number">5612993</span></span><br><span class="line">   SUM_NUMBER_OF_BYTES_ALLOC: <span class="number">193239513120</span></span><br><span class="line">    SUM_NUMBER_OF_BYTES_FREE: <span class="number">193239513120</span></span><br><span class="line">              LOW_COUNT_USED: <span class="number">0</span></span><br><span class="line">          CURRENT_COUNT_USED: <span class="number">0</span></span><br><span class="line">             HIGH_COUNT_USED: <span class="number">20</span></span><br><span class="line">    LOW_NUMBER_OF_BYTES_USED: <span class="number">0</span></span><br><span class="line">CURRENT_NUMBER_OF_BYTES_USED: <span class="number">0</span></span><br><span class="line">   HIGH_NUMBER_OF_BYTES_USED: <span class="number">819840</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> memory_summary_by_thread_by_event_name <span class="keyword">where</span> EVENT_NAME<span class="operator">=</span><span class="string">&#x27;memory/sql/Filesort_buffer::sort_keys&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> SUM_NUMBER_OF_BYTES_ALLOC <span class="keyword">desc</span> limit <span class="number">1</span>\G;</span><br><span class="line"></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">                   THREAD_ID: <span class="number">84</span></span><br><span class="line">                  EVENT_NAME: memory<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>Filesort_buffer::sort_keys</span><br><span class="line">                 COUNT_ALLOC: <span class="number">565645</span></span><br><span class="line">                  COUNT_FREE: <span class="number">565645</span></span><br><span class="line">   SUM_NUMBER_OF_BYTES_ALLOC: <span class="number">19475083680</span></span><br><span class="line">    SUM_NUMBER_OF_BYTES_FREE: <span class="number">19475083680</span></span><br><span class="line">              LOW_COUNT_USED: <span class="number">0</span></span><br><span class="line">          CURRENT_COUNT_USED: <span class="number">0</span></span><br><span class="line">             HIGH_COUNT_USED: <span class="number">2</span></span><br><span class="line">    LOW_NUMBER_OF_BYTES_USED: <span class="number">0</span></span><br><span class="line">CURRENT_NUMBER_OF_BYTES_USED: <span class="number">0</span></span><br><span class="line">   HIGH_NUMBER_OF_BYTES_USED: <span class="number">81984</span></span><br></pre></td></tr></table></figure><p>现在我们查到了用户及其线程 <code>ID</code> 的全部详细信息，让我们查一下这个线程正在执行哪种查询。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> events_statements_history <span class="keyword">where</span> THREAD_ID<span class="operator">=</span><span class="number">84</span> <span class="keyword">order</span> <span class="keyword">by</span> SORT_SCAN <span class="keyword">desc</span>\G;</span><br><span class="line"></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">              THREAD_ID: <span class="number">84</span></span><br><span class="line">               EVENT_ID: <span class="number">48091828</span></span><br><span class="line">           END_EVENT_ID: <span class="number">48091833</span></span><br><span class="line">             EVENT_NAME: statement<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span><span class="keyword">select</span></span><br><span class="line">                 SOURCE: init_net_server_extension.cc:<span class="number">95</span></span><br><span class="line">            TIMER_START: <span class="number">145083499054314000</span></span><br><span class="line">              TIMER_END: <span class="number">145083499243093000</span></span><br><span class="line">             TIMER_WAIT: <span class="number">188779000</span></span><br><span class="line">              LOCK_TIME: <span class="number">1000000</span></span><br><span class="line">               SQL_TEXT: <span class="keyword">SELECT</span> c <span class="keyword">FROM</span> sbtest2 <span class="keyword">WHERE</span> id <span class="keyword">BETWEEN</span> <span class="number">5744223</span> <span class="keyword">AND</span> <span class="number">5744322</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> c</span><br><span class="line">                 DIGEST: <span class="number">4</span>f764af1c0d6e44e4666e887d454a241a09ac8c4df9d5c2479f08b00e4b9b80d</span><br><span class="line">            DIGEST_TEXT: <span class="keyword">SELECT</span> `c` <span class="keyword">FROM</span> `sbtest2` <span class="keyword">WHERE</span> `id` <span class="keyword">BETWEEN</span> ? <span class="keyword">AND</span> ? <span class="keyword">ORDER</span> <span class="keyword">BY</span> `c`</span><br><span class="line">         <span class="built_in">CURRENT_SCHEMA</span>: sysbench</span><br><span class="line">            OBJECT_TYPE: <span class="keyword">NULL</span></span><br><span class="line">          OBJECT_SCHEMA: <span class="keyword">NULL</span></span><br><span class="line">            OBJECT_NAME: <span class="keyword">NULL</span></span><br><span class="line">  OBJECT_INSTANCE_BEGIN: <span class="keyword">NULL</span></span><br><span class="line">            MYSQL_ERRNO: <span class="number">0</span></span><br><span class="line">      RETURNED_SQLSTATE: <span class="keyword">NULL</span></span><br><span class="line">           MESSAGE_TEXT: <span class="keyword">NULL</span></span><br><span class="line">                 ERRORS: <span class="number">0</span></span><br><span class="line">               WARNINGS: <span class="number">0</span></span><br><span class="line">          ROWS_AFFECTED: <span class="number">0</span></span><br><span class="line">              ROWS_SENT: <span class="number">14</span></span><br><span class="line">          ROWS_EXAMINED: <span class="number">28</span></span><br><span class="line">CREATED_TMP_DISK_TABLES: <span class="number">0</span></span><br><span class="line">     CREATED_TMP_TABLES: <span class="number">0</span></span><br><span class="line">       SELECT_FULL_JOIN: <span class="number">0</span></span><br><span class="line"> SELECT_FULL_RANGE_JOIN: <span class="number">0</span></span><br><span class="line">           SELECT_RANGE: <span class="number">1</span></span><br><span class="line">     SELECT_RANGE_CHECK: <span class="number">0</span></span><br><span class="line">            SELECT_SCAN: <span class="number">0</span></span><br><span class="line">      SORT_MERGE_PASSES: <span class="number">0</span></span><br><span class="line">         SORT_RANGE: <span class="number">0</span></span><br><span class="line">              SORT_ROWS: <span class="number">14</span></span><br><span class="line">          SORT_SCAN: <span class="number">1</span></span><br><span class="line">          NO_INDEX_USED: <span class="number">0</span></span><br><span class="line">     NO_GOOD_INDEX_USED: <span class="number">0</span></span><br><span class="line">       NESTING_EVENT_ID: <span class="keyword">NULL</span></span><br><span class="line">     NESTING_EVENT_TYPE: <span class="keyword">NULL</span></span><br><span class="line">    NESTING_EVENT_LEVEL: <span class="number">0</span></span><br><span class="line">           STATEMENT_ID: <span class="number">49021382</span></span><br><span class="line">               CPU_TIME: <span class="number">185100000</span></span><br><span class="line">       EXECUTION_ENGINE: <span class="keyword">PRIMARY</span></span><br></pre></td></tr></table></figure><p>我在这里仅根据 <code>rows_scan</code>（代表的是表扫描）粘贴了一条记录，我们也可以在案例中找到类似的其他查询，然后尝试通过创建索引或其他一些恰当的方式来优化查询。</p><p><strong>案例二</strong></p><p>我们来尝试排查表锁定的情况，例如：有哪些锁？读锁还是写锁等？已经在用户表上加锁多长时间（以<strong>皮秒</strong>为单位显示）。</p><p>我们先给一张表加上写锁：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> lock tables sbtest2 write;</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> processlist;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+---------------------+--------------------+-------------+--------+-----------------------------------------------------------------+------------------+-----------+-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> Id <span class="operator">|</span> <span class="keyword">User</span>   <span class="operator">|</span> Host                <span class="operator">|</span> db                 <span class="operator">|</span> Command     <span class="operator">|</span> <span class="type">Time</span>   <span class="operator">|</span> State                                                           <span class="operator">|</span> Info             <span class="operator">|</span> Time_ms   <span class="operator">|</span> Rows_sent <span class="operator">|</span> Rows_examined <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+---------------------+--------------------+-------------+--------+-----------------------------------------------------------------+------------------+-----------+-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">8</span> <span class="operator">|</span> repl   <span class="operator">|</span> <span class="number">10.11</span><span class="number">.139</span><span class="number">.171</span>:<span class="number">53860</span> <span class="operator">|</span> <span class="keyword">NULL</span>               <span class="operator">|</span> Binlog Dump <span class="operator">|</span> <span class="number">421999</span> <span class="operator">|</span> Source has sent <span class="keyword">all</span> binlog <span class="keyword">to</span> replica; waiting <span class="keyword">for</span> more updates <span class="operator">|</span> <span class="keyword">NULL</span>             <span class="operator">|</span> <span class="number">421998368</span> <span class="operator">|</span>         <span class="number">0</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">9</span> <span class="operator">|</span> repl   <span class="operator">|</span> <span class="number">10.11</span><span class="number">.223</span><span class="number">.98</span>:<span class="number">51212</span>  <span class="operator">|</span> <span class="keyword">NULL</span>               <span class="operator">|</span> Binlog Dump <span class="operator">|</span> <span class="number">421998</span> <span class="operator">|</span> Source has sent <span class="keyword">all</span> binlog <span class="keyword">to</span> replica; waiting <span class="keyword">for</span> more updates <span class="operator">|</span> <span class="keyword">NULL</span>             <span class="operator">|</span> <span class="number">421998262</span> <span class="operator">|</span>         <span class="number">0</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">25</span> <span class="operator">|</span> sbuser <span class="operator">|</span> <span class="number">10.11</span><span class="number">.54</span><span class="number">.152</span>:<span class="number">38060</span>  <span class="operator">|</span> sysbench           <span class="operator">|</span> Sleep       <span class="operator">|</span>  <span class="number">65223</span> <span class="operator">|</span>                                                                 <span class="operator">|</span> <span class="keyword">NULL</span>             <span class="operator">|</span>  <span class="number">65222573</span> <span class="operator">|</span>         <span class="number">0</span> <span class="operator">|</span>             <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">26</span> <span class="operator">|</span> sbuser <span class="operator">|</span> <span class="number">10.11</span><span class="number">.54</span><span class="number">.152</span>:<span class="number">38080</span>  <span class="operator">|</span> sysbench           <span class="operator">|</span> Sleep       <span class="operator">|</span>  <span class="number">65222</span> <span class="operator">|</span>                                                                 <span class="operator">|</span> <span class="keyword">NULL</span>             <span class="operator">|</span>  <span class="number">65222177</span> <span class="operator">|</span>         <span class="number">0</span> <span class="operator">|</span>             <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">27</span> <span class="operator">|</span> sbuser <span class="operator">|</span> <span class="number">10.11</span><span class="number">.54</span><span class="number">.152</span>:<span class="number">38090</span>  <span class="operator">|</span> sysbench           <span class="operator">|</span> Sleep       <span class="operator">|</span>  <span class="number">65223</span> <span class="operator">|</span>                                                                 <span class="operator">|</span> <span class="keyword">NULL</span>             <span class="operator">|</span>  <span class="number">65222438</span> <span class="operator">|</span>         <span class="number">0</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">28</span> <span class="operator">|</span> sbuser <span class="operator">|</span> <span class="number">10.11</span><span class="number">.54</span><span class="number">.152</span>:<span class="number">38096</span>  <span class="operator">|</span> sysbench           <span class="operator">|</span> Sleep       <span class="operator">|</span>  <span class="number">65223</span> <span class="operator">|</span>                                                                 <span class="operator">|</span> <span class="keyword">NULL</span>             <span class="operator">|</span>  <span class="number">65222489</span> <span class="operator">|</span>         <span class="number">0</span> <span class="operator">|</span>             <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">29</span> <span class="operator">|</span> sbuser <span class="operator">|</span> <span class="number">10.11</span><span class="number">.54</span><span class="number">.152</span>:<span class="number">38068</span>  <span class="operator">|</span> sysbench           <span class="operator">|</span> Sleep       <span class="operator">|</span>  <span class="number">65223</span> <span class="operator">|</span>                                                                 <span class="operator">|</span> <span class="keyword">NULL</span>             <span class="operator">|</span>  <span class="number">65222527</span> <span class="operator">|</span>         <span class="number">0</span> <span class="operator">|</span>             <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">45</span> <span class="operator">|</span> root   <span class="operator">|</span> localhost           <span class="operator">|</span> performance_schema <span class="operator">|</span> Sleep       <span class="operator">|</span>   <span class="number">7722</span> <span class="operator">|</span>                                                                 <span class="operator">|</span> <span class="keyword">NULL</span>             <span class="operator">|</span>   <span class="number">7722009</span> <span class="operator">|</span>        <span class="number">40</span> <span class="operator">|</span>           <span class="number">348</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">46</span> <span class="operator">|</span> root   <span class="operator">|</span> localhost           <span class="operator">|</span> performance_schema <span class="operator">|</span> Sleep       <span class="operator">|</span>   <span class="number">6266</span> <span class="operator">|</span>                                                                 <span class="operator">|</span> <span class="keyword">NULL</span>             <span class="operator">|</span>   <span class="number">6265800</span> <span class="operator">|</span>        <span class="number">16</span> <span class="operator">|</span>          <span class="number">1269</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">47</span> <span class="operator">|</span> root   <span class="operator">|</span> localhost           <span class="operator">|</span> performance_schema <span class="operator">|</span> Sleep       <span class="operator">|</span>   <span class="number">4904</span> <span class="operator">|</span>                                                                 <span class="operator">|</span> <span class="keyword">NULL</span>             <span class="operator">|</span>   <span class="number">4903622</span> <span class="operator">|</span>         <span class="number">0</span> <span class="operator">|</span>            <span class="number">23</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">48</span> <span class="operator">|</span> root   <span class="operator">|</span> localhost           <span class="operator">|</span> performance_schema <span class="operator">|</span> Sleep       <span class="operator">|</span>   <span class="number">1777</span> <span class="operator">|</span>                                                                 <span class="operator">|</span> <span class="keyword">NULL</span>             <span class="operator">|</span>   <span class="number">1776860</span> <span class="operator">|</span>         <span class="number">0</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">54</span> <span class="operator">|</span> root   <span class="operator">|</span> localhost           <span class="operator">|</span> sysbench           <span class="operator">|</span> Sleep       <span class="operator">|</span>    <span class="number">689</span> <span class="operator">|</span>                                                                 <span class="operator">|</span> <span class="keyword">NULL</span>             <span class="operator">|</span>    <span class="number">688740</span> <span class="operator">|</span>         <span class="number">0</span> <span class="operator">|</span>             <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">58</span> <span class="operator">|</span> root   <span class="operator">|</span> localhost           <span class="operator">|</span> <span class="keyword">NULL</span>               <span class="operator">|</span> Sleep       <span class="operator">|</span>     <span class="number">44</span> <span class="operator">|</span>                                                                 <span class="operator">|</span> <span class="keyword">NULL</span>             <span class="operator">|</span>     <span class="number">44263</span> <span class="operator">|</span>         <span class="number">1</span> <span class="operator">|</span>             <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">59</span> <span class="operator">|</span> root   <span class="operator">|</span> localhost           <span class="operator">|</span> sysbench           <span class="operator">|</span> Query       <span class="operator">|</span>      <span class="number">0</span> <span class="operator">|</span> init                                                            <span class="operator">|</span> <span class="keyword">show</span> processlist <span class="operator">|</span>         <span class="number">0</span> <span class="operator">|</span>         <span class="number">0</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+---------------------+--------------------+-------------+--------+-----------------------------------------------------------------+------------------+-------------------+-------------------+</span></span><br></pre></td></tr></table></figure><p>现在思考这样一种情况，我们不知道该会话存在，并且正在尝试读取该表数据并需要等待<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.6/en/metadata-locking.html">元数据锁定</a>。在这种情况下，我们需要借助与锁相关的 <code>Instrument</code>（找出哪个会话正在锁定该表），例如：<strong>wait/table/lock/sql/handler</strong>（<code>table_handles</code> 表负责存储表锁相关的 <code>Instrument</code>）：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> table_handles <span class="keyword">where</span> object_name<span class="operator">=</span><span class="string">&#x27;sbtest2&#x27;</span> <span class="keyword">and</span> OWNER_THREAD_ID <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+---------------+-------------+-----------------------+-----------------+----------------+---------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> OBJECT_TYPE <span class="operator">|</span> OBJECT_SCHEMA <span class="operator">|</span> OBJECT_NAME <span class="operator">|</span> OBJECT_INSTANCE_BEGIN <span class="operator">|</span> OWNER_THREAD_ID <span class="operator">|</span> OWNER_EVENT_ID <span class="operator">|</span> INTERNAL_LOCK <span class="operator">|</span> EXTERNAL_LOCK  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+---------------+-------------+-----------------------+-----------------+----------------+---------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">TABLE</span>       <span class="operator">|</span> sysbench      <span class="operator">|</span> sbtest2     <span class="operator">|</span>       <span class="number">140087472317648</span> <span class="operator">|</span>             <span class="number">141</span> <span class="operator">|</span>             <span class="number">77</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> WRITE <span class="keyword">EXTERNAL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+---------------+-------------+-----------------------+-----------------+----------------+---------------+----------------+</span></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> metadata_locks;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+--------------------+------------------+-------------+-----------------------+----------------------+---------------+-------------+-------------------+-----------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> OBJECT_TYPE   <span class="operator">|</span> OBJECT_SCHEMA      <span class="operator">|</span> OBJECT_NAME      <span class="operator">|</span> COLUMN_NAME <span class="operator">|</span> OBJECT_INSTANCE_BEGIN <span class="operator">|</span> LOCK_TYPE            <span class="operator">|</span> LOCK_DURATION <span class="operator">|</span> LOCK_STATUS <span class="operator">|</span> SOURCE            <span class="operator">|</span> OWNER_THREAD_ID <span class="operator">|</span> OWNER_EVENT_ID <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+--------------------+------------------+-------------+-----------------------+----------------------+---------------+-------------+-------------------+-----------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GLOBAL</span>        <span class="operator">|</span> <span class="keyword">NULL</span>               <span class="operator">|</span> <span class="keyword">NULL</span>             <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span>       <span class="number">140087472151024</span> <span class="operator">|</span> INTENTION_EXCLUSIVE  <span class="operator">|</span> STATEMENT     <span class="operator">|</span> GRANTED     <span class="operator">|</span> sql_base.cc:<span class="number">5534</span>  <span class="operator">|</span>             <span class="number">141</span> <span class="operator">|</span>             <span class="number">77</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> SCHEMA        <span class="operator">|</span> sysbench           <span class="operator">|</span> <span class="keyword">NULL</span>             <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span>       <span class="number">140087472076832</span> <span class="operator">|</span> INTENTION_EXCLUSIVE  <span class="operator">|</span> TRANSACTION   <span class="operator">|</span> GRANTED     <span class="operator">|</span> sql_base.cc:<span class="number">5521</span>  <span class="operator">|</span>             <span class="number">141</span> <span class="operator">|</span>             <span class="number">77</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">TABLE</span>         <span class="operator">|</span> sysbench           <span class="operator">|</span> sbtest2          <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span>       <span class="number">140087471957616</span> <span class="operator">|</span> SHARED_NO_READ_WRITE <span class="operator">|</span> TRANSACTION   <span class="operator">|</span> GRANTED     <span class="operator">|</span> sql_parse.cc:<span class="number">6295</span> <span class="operator">|</span>             <span class="number">141</span> <span class="operator">|</span>             <span class="number">77</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> BACKUP TABLES <span class="operator">|</span> <span class="keyword">NULL</span>               <span class="operator">|</span> <span class="keyword">NULL</span>             <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span>       <span class="number">140087472077120</span> <span class="operator">|</span> INTENTION_EXCLUSIVE  <span class="operator">|</span> STATEMENT     <span class="operator">|</span> GRANTED     <span class="operator">|</span> lock.cc:<span class="number">1259</span>      <span class="operator">|</span>             <span class="number">141</span> <span class="operator">|</span>             <span class="number">77</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> TABLESPACE    <span class="operator">|</span> <span class="keyword">NULL</span>               <span class="operator">|</span> sysbench<span class="operator">/</span>sbtest2 <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span>       <span class="number">140087471954800</span> <span class="operator">|</span> INTENTION_EXCLUSIVE  <span class="operator">|</span> TRANSACTION   <span class="operator">|</span> GRANTED     <span class="operator">|</span> lock.cc:<span class="number">812</span>       <span class="operator">|</span>             <span class="number">141</span> <span class="operator">|</span>             <span class="number">77</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">TABLE</span>         <span class="operator">|</span> sysbench           <span class="operator">|</span> sbtest2          <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span>       <span class="number">140087673437920</span> <span class="operator">|</span> SHARED_READ          <span class="operator">|</span> TRANSACTION   <span class="operator">|</span> PENDING     <span class="operator">|</span> sql_parse.cc:<span class="number">6295</span> <span class="operator">|</span>             <span class="number">142</span> <span class="operator">|</span>             <span class="number">77</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">TABLE</span>         <span class="operator">|</span> performance_schema <span class="operator">|</span> metadata_locks   <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span>       <span class="number">140088117153152</span> <span class="operator">|</span> SHARED_READ          <span class="operator">|</span> TRANSACTION   <span class="operator">|</span> GRANTED     <span class="operator">|</span> sql_parse.cc:<span class="number">6295</span> <span class="operator">|</span>             <span class="number">143</span> <span class="operator">|</span>            <span class="number">970</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">TABLE</span>         <span class="operator">|</span> sysbench           <span class="operator">|</span> sbtest1          <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span>       <span class="number">140087543861792</span> <span class="operator">|</span> SHARED_WRITE         <span class="operator">|</span> TRANSACTION   <span class="operator">|</span> GRANTED     <span class="operator">|</span> sql_parse.cc:<span class="number">6295</span> <span class="operator">|</span>             <span class="number">132</span> <span class="operator">|</span>            <span class="number">156</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+--------------------+------------------+-------------+-----------------------+----------------------+---------------+-------------+-------------------+-----------------+----------------+</span></span><br></pre></td></tr></table></figure><p>通过查询结果我们知道 <code>ID</code> 为 <code>141</code> 的线程在 <code>sbtest2</code> 表上持有锁<strong>SHARED_NO_READ_WRITE</strong>，因此我们可以采取一些处理措施，例如我们可以根据实际情况，提交会话或者终止会话。我们需要从线程表中找到相应的 <code>processlist_id</code> 来杀死它。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> kill <span class="number">63</span>;</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> table_handles <span class="keyword">where</span> object_name<span class="operator">=</span><span class="string">&#x27;sbtest2&#x27;</span> <span class="keyword">and</span> OWNER_THREAD_ID <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p><strong>案例三</strong></p><p>在某些情况下，我们需要找出 <code>MySQL</code> 服务器在哪里出现等待而花费了大部分时间，以便我们可以进一步采取措施：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> events_waits_history <span class="keyword">order</span> <span class="keyword">by</span> TIMER_WAIT <span class="keyword">desc</span> limit <span class="number">2</span>\G;</span><br><span class="line"></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">            THREAD_ID: <span class="number">88</span></span><br><span class="line">             EVENT_ID: <span class="number">124481038</span></span><br><span class="line">         END_EVENT_ID: <span class="number">124481038</span></span><br><span class="line">           EVENT_NAME: wait<span class="operator">/</span>io<span class="operator">/</span>file<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>binlog</span><br><span class="line">               SOURCE: mf_iocache.cc:<span class="number">1694</span></span><br><span class="line">          TIMER_START: <span class="number">356793339225677600</span></span><br><span class="line">            TIMER_END: <span class="number">420519408945931200</span></span><br><span class="line">           TIMER_WAIT: <span class="number">63726069720253600</span></span><br><span class="line">                SPINS: <span class="keyword">NULL</span></span><br><span class="line">        OBJECT_SCHEMA: <span class="keyword">NULL</span></span><br><span class="line">          OBJECT_NAME: <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>mysqld<span class="operator">-</span>bin<span class="number">.000009</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">NULL</span></span><br><span class="line">          OBJECT_TYPE: FILE</span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">140092364472192</span></span><br><span class="line">     NESTING_EVENT_ID: <span class="number">124481033</span></span><br><span class="line">   NESTING_EVENT_TYPE: STATEMENT</span><br><span class="line">            OPERATION: write</span><br><span class="line">      NUMBER_OF_BYTES: <span class="number">683</span></span><br><span class="line">                FLAGS: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">            THREAD_ID: <span class="number">142</span></span><br><span class="line">             EVENT_ID: <span class="number">77</span></span><br><span class="line">         END_EVENT_ID: <span class="number">77</span></span><br><span class="line">           EVENT_NAME: wait<span class="operator">/</span>lock<span class="operator">/</span>metadata<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>mdl</span><br><span class="line">               SOURCE: mdl.cc:<span class="number">3443</span></span><br><span class="line">          TIMER_START: <span class="number">424714091048155200</span></span><br><span class="line">            TIMER_END: <span class="number">426449252955162400</span></span><br><span class="line">           TIMER_WAIT: <span class="number">1735161907007200</span></span><br><span class="line">                SPINS: <span class="keyword">NULL</span></span><br><span class="line">        OBJECT_SCHEMA: sysbench</span><br><span class="line">          OBJECT_NAME: sbtest2</span><br><span class="line">           INDEX_NAME: <span class="keyword">NULL</span></span><br><span class="line">          OBJECT_TYPE: <span class="keyword">TABLE</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">140087673437920</span></span><br><span class="line">     NESTING_EVENT_ID: <span class="number">76</span></span><br><span class="line">   NESTING_EVENT_TYPE: STATEMENT</span><br><span class="line">            OPERATION: metadata lock</span><br><span class="line">      NUMBER_OF_BYTES: <span class="keyword">NULL</span></span><br><span class="line">                FLAGS: <span class="keyword">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>在上面的例子中，<strong>bin log file</strong> 已经等待了很长时间（<code>timer_wait</code> 单位是皮秒），在等待 <code>mysqld-bin.000009</code> 文件完成 <code>IO</code> 操作。当然这可能是由于多种原因导致，例如存储空间已满。接下来的记录显示了我之前解释的示例二的详细信息。</p><h3 id="还有什么？"><a href="#还有什么？" class="headerlink" title="还有什么？"></a>还有什么？</h3><p>为了让工作更轻松，能够更方便地监控这些 <code>Instrument</code>，<a target="_blank" rel="noopener" href="https://docs.percona.com/percona-monitoring-and-management/index.html">Percona Monitoring and Management(PMM)</a> 扮演着重要的角色。例如，请参见下面的截图信息。</p><img src="https://cdn.jsdelivr.net/gh/dongzl/dongzl.github.io@hexo/source/images/2023/03-Deep-Dive-into-MySQL-Performance-Schema/01.png"> <img src="https://cdn.jsdelivr.net/gh/dongzl/dongzl.github.io@hexo/source/images/2023/03-Deep-Dive-into-MySQL-Performance-Schema/02.png"><p>我们仅使用这些图表，几乎可以将所有的 <code>Instrument</code> 通过配置成进行监控，而不用进行数据查询。如果要熟悉这些内容，请查看 PMM <a target="_blank" rel="noopener" href="https://pmm2demo.percona.com/graph/d/mysql-performance-schema/mysql-performance-schema-details?from=now-12h&to=now&var-interval=$__auto_interval_interval&var-environment=All&var-node_name=&var-crop_host=&var-service_name=pxc57-2-mysql&var-region=&var-cluster=PXCCluster1&var-node_id=&var-agent_id=&var-service_id=%2Fservice_id%2F03d49df4-3870-460b-a5e4-94647b56a99d&var-az=&var-node_type=All&var-node_model=&var-replication_set=All&var-version=&var-service_type=All&var-database=All&var-username=All&var-schema=All&orgId=1&refresh=1m">示例</a>。</p><p>显然，了解 <code>performance schema</code> 对我们有很大帮助，但是启用这个特性会产生额外成本，会影响数据库性能。因此在许多场景下，<a target="_blank" rel="noopener" href="https://docs.percona.com/percona-toolkit/">Percona Toolkit</a> 能够在不影响数据库性能的情况下发挥很大有用。例如：<code>pt-index-usage</code>、<code>pt-online-schema-change</code>、<code>pt-query-digest</code>等工具。</p><p><strong>几点重要说明</strong></p><ol><li>历史表数据会在一段时间后加载，而不是立即进行加载。只有在一个线程执行完成之后进行加载；</li><li>启用所有 <code>Instrument</code> 可能会影响 <code>MySQL</code> 性能，因为一旦开启后，会向内存表写入更多数据。此外也需要投入额外更多的成本，所以尽量根据实际需要去启用 <code>Instrument</code>；</li><li><code>PMM</code> 包含大部分 <code>Instrument</code>，我们也可以根据需要配置更多 <code>Instrument</code> 监控；</li><li>我们不需要记住所有表的名称。我们可以只使用 <code>PMM</code> 或使用表连接来创建查询。本文将整个概念分散成多个小部分内容，因此没有使用任何连接操作，以便读者可以更好理解它；</li><li>启用多种 <code>Instrument</code> 的最佳方式是先在预生产环境进行优化，然后再部署到生产环境中。</li></ol><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>在对 <code>MySQL</code> 服务器进行故障排查时，<code>performance schema</code> 非常有用。我们需要找出所需要的 <code>Instrument</code>。如果我们仍在为数据库性能而烦恼，请随时联系我们，我们将非常乐意为您提供帮助。</p><div class="post-announce">感谢您的阅读，本文由 <a href="https://dongzl.github.io">董宗磊的博客</a> 版权所有。如若转载，请注明出处：董宗磊的博客（<a href="https://dongzl.github.io/2023/02/17/03-Deep-Dive-into-MySQL-Performance-Schema/">https://dongzl.github.io/2023/02/17/03-Deep-Dive-into-MySQL-Performance-Schema/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/2023/02/10/02-Building-A-GRPC-Server-With-Rust/" title="使用 Rust 一步一步构建 gRPC 服务器"><i class="iconfont icon-prev"></i>使用 Rust 一步一步构建 gRPC 服务器</a></div><div class="post__prev post__prev--right"><a href="/2023/03/05/04-Linux-Zero-Copy/" title="Linux 系统零拷贝--什么是零拷贝以及零拷贝实现原理">Linux 系统零拷贝--什么是零拷贝以及零拷贝实现原理<i class="iconfont icon-next"></i></a></div></div></div></article><div id="comment-container"></div></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">记录自己作为程序员的技术成长经历，程序员是个特殊的职业，一旦选择这个职业就要时刻保持学习的热情，如果你也喜欢我的博客，欢迎订阅 RSS。</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记</a><span class="block-list-count">4</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a><span class="block-list-count">5</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/">架构设计</a><span class="block-list-count">29</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/">数据结构与算法</a><span class="block-list-count">4</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span class="block-list-count">25</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a><span class="block-list-count">6</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/web%E5%BC%80%E5%8F%91/">web开发</a><span class="block-list-count">11</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/java%E5%BC%80%E5%8F%91/">java开发</a><span class="block-list-count">12</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Go%E8%AF%AD%E8%A8%80/">Go语言</a><span class="block-list-count">1</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2023/12/19/26-Asynchronous-API-Design-Best-Practices-Server-Sent-Event/" title="异步 API 设计最佳实践：用于实时通信的服务端事件发送 (SSE)"><div class="item__cover"><img src="https://cdn.jsdelivr.net/gh/dongzl/dongzl.github.io@hexo/source/images/cover/async_vs_sync.png" alt="异步 API 设计最佳实践：用于实时通信的服务端事件发送 (SSE)"></div><div class="item__info"><h3 class="item__title">异步 API 设计最佳实践：用于实时通信的服务端事件发送 (SSE)</h3><span class="item__text">2023-12-19</span></div></a></li><li class="latest-post-item"><a href="/2023/11/18/25-Difference-Between-Forward-Proxy-Reverse-Proxy-System-Design/" title="系统设计中正向代理和反向代理的差异"><div class="item__cover"><img src="https://cdn.jsdelivr.net/gh/dongzl/dongzl.github.io@hexo/source/images/cover/forward_reverse_proxy_v2.png" alt="系统设计中正向代理和反向代理的差异"></div><div class="item__info"><h3 class="item__title">系统设计中正向代理和反向代理的差异</h3><span class="item__text">2023-11-18</span></div></a></li><li class="latest-post-item"><a href="/2023/09/23/24-Scaling-Microservices-Strategies-Handling-Increased-Demand-Efficiency/" title="微服务扩展：以 99% 的处理效率来应对不断增长的需求"><div class="item__cover"><img src="https://cdn.jsdelivr.net/gh/dongzl/dongzl.github.io@hexo/source/images/cover/scaling_microservices.png" alt="微服务扩展：以 99% 的处理效率来应对不断增长的需求"></div><div class="item__info"><h3 class="item__title">微服务扩展：以 99% 的处理效率来应对不断增长的需求</h3><span class="item__text">2023-09-23</span></div></a></li><li class="latest-post-item"><a href="/2023/08/27/23-Difference-Between-SAGA-CQRS-Design-Patterns-Microservices/" title="微服务中 SAGA 和 CQRS 设计模式的差异？"><div class="item__cover"><img src="https://cdn.jsdelivr.net/gh/dongzl/dongzl.github.io@hexo/source/images/cover/SAGA_vs_CQRS.png" alt="微服务中 SAGA 和 CQRS 设计模式的差异？"></div><div class="item__info"><h3 class="item__title">微服务中 SAGA 和 CQRS 设计模式的差异？</h3><span class="item__text">2023-08-27</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/AQS/">AQS</a></li><li class="tag-item"><a class="tag-link" href="/tags/ActiveMQ/">ActiveMQ</a></li><li class="tag-item"><a class="tag-link" href="/tags/Apache/">Apache</a></li><li class="tag-item"><a class="tag-link" href="/tags/BloomFilter/">BloomFilter</a></li><li class="tag-item"><a class="tag-link" href="/tags/CQRS/">CQRS</a></li><li class="tag-item"><a class="tag-link" href="/tags/Calcite/">Calcite</a></li><li class="tag-item"><a class="tag-link" href="/tags/ClickHouse/">ClickHouse</a></li><li class="tag-item"><a class="tag-link" href="/tags/CountDownLatch/">CountDownLatch</a></li><li class="tag-item"><a class="tag-link" href="/tags/Docker/">Docker</a></li><li class="tag-item"><a class="tag-link" href="/tags/EventBus/">EventBus</a></li><li class="tag-item"><a class="tag-link" href="/tags/Full-GC/">Full GC</a></li><li class="tag-item"><a class="tag-link" href="/tags/Go/">Go</a></li><li class="tag-item"><a class="tag-link" href="/tags/GraphQL/">GraphQL</a></li><li class="tag-item"><a class="tag-link" href="/tags/Guava/">Guava</a></li><li class="tag-item"><a class="tag-link" href="/tags/Hexo/">Hexo</a></li><li class="tag-item"><a class="tag-link" href="/tags/Hibernate/">Hibernate</a></li><li class="tag-item"><a class="tag-link" href="/tags/Istio/">Istio</a></li><li class="tag-item"><a class="tag-link" href="/tags/JPA/">JPA</a></li><li class="tag-item"><a class="tag-link" href="/tags/JSON/">JSON</a></li><li class="tag-item"><a class="tag-link" href="/tags/JVM/">JVM</a></li><li class="tag-item"><a class="tag-link" href="/tags/JWT/">JWT</a></li><li class="tag-item"><a class="tag-link" href="/tags/Kafka/">Kafka</a></li><li class="tag-item"><a class="tag-link" href="/tags/Linux/">Linux</a></li><li class="tag-item"><a class="tag-link" href="/tags/Lock/">Lock</a></li><li class="tag-item"><a class="tag-link" href="/tags/Lombok/">Lombok</a></li><li class="tag-item"><a class="tag-link" href="/tags/MAT/">MAT</a></li><li class="tag-item"><a class="tag-link" href="/tags/Map/">Map</a></li><li class="tag-item"><a class="tag-link" href="/tags/Microservices/">Microservices</a></li><li class="tag-item"><a class="tag-link" href="/tags/MySQL/">MySQL</a></li><li class="tag-item"><a class="tag-link" href="/tags/OAuth/">OAuth</a></li><li class="tag-item"><a class="tag-link" href="/tags/Performance-Schema/">Performance Schema</a></li><li class="tag-item"><a class="tag-link" href="/tags/REST/">REST</a></li><li class="tag-item"><a class="tag-link" href="/tags/RSocket/">RSocket</a></li><li class="tag-item"><a class="tag-link" href="/tags/RabbitMQ/">RabbitMQ</a></li><li class="tag-item"><a class="tag-link" href="/tags/Reactor/">Reactor</a></li><li class="tag-item"><a class="tag-link" href="/tags/Redis/">Redis</a></li><li class="tag-item"><a class="tag-link" href="/tags/Rust/">Rust</a></li><li class="tag-item"><a class="tag-link" href="/tags/SAGA/">SAGA</a></li><li class="tag-item"><a class="tag-link" href="/tags/SAML/">SAML</a></li><li class="tag-item"><a class="tag-link" href="/tags/SPI/">SPI</a></li><li class="tag-item"><a class="tag-link" href="/tags/SSE/">SSE</a></li><li class="tag-item"><a class="tag-link" href="/tags/Security/">Security</a></li><li class="tag-item"><a class="tag-link" href="/tags/Service-Mesh/">Service Mesh</a></li><li class="tag-item"><a class="tag-link" href="/tags/ShardingSphere/">ShardingSphere</a></li><li class="tag-item"><a class="tag-link" href="/tags/Singleton/">Singleton</a></li><li class="tag-item"><a class="tag-link" href="/tags/Spring/">Spring</a></li><li class="tag-item"><a class="tag-link" href="/tags/Spring-Data-JPA/">Spring Data JPA</a></li><li class="tag-item"><a class="tag-link" href="/tags/TestContainers/">TestContainers</a></li><li class="tag-item"><a class="tag-link" href="/tags/Thread/">Thread</a></li><li class="tag-item"><a class="tag-link" href="/tags/ThreadPoolExecutor/">ThreadPoolExecutor</a></li><li class="tag-item"><a class="tag-link" href="/tags/Wireshark/">Wireshark</a></li><li class="tag-item"><a class="tag-link" href="/tags/Zero-Copy/">Zero Copy</a></li><li class="tag-item"><a class="tag-link" href="/tags/ZooKeeper/">ZooKeeper</a></li><li class="tag-item"><a class="tag-link" href="/tags/eBPF/">eBPF</a></li><li class="tag-item"><a class="tag-link" href="/tags/gRPC/">gRPC</a></li><li class="tag-item"><a class="tag-link" href="/tags/hexo/">hexo</a></li><li class="tag-item"><a class="tag-link" href="/tags/maven/">maven</a></li><li class="tag-item"><a class="tag-link" href="/tags/synchronized/">synchronized</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4/">两阶段提交</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/">主从复制</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E4%BA%8B%E4%BB%B6%E6%BA%AF%E6%BA%90/">事件溯源</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E4%BA%8B%E5%8A%A1/">事务</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/">分布式系统</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/">反向代理</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%BC%B9%E6%80%A7/">弹性</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E6%80%BB%E7%BB%93/">总结</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F/">数学公式</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86/">正向代理</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E6%B2%89%E6%80%9D%E5%BD%95/">沉思录</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/">策略模式</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E7%AE%97%E6%B3%95/">算法</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E7%B4%A2%E5%BC%95/">索引</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/">线程池</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E7%BD%91%E5%85%B3/">网关</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/">观察者模式</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/">计算机组成原理</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/">设计原则</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E8%B0%83%E4%BC%98/">调优</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">负载均衡</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">关于</h3><div class="item__content"><p class="item__text">本站是基于 Hexo 搭建的静态资源博客，主要用于分享日常学习、生活及工作的一些心得总结，欢迎点击右下角订阅 rss。</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Beijing, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>dongzonglei@apache.org</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="/img/theme/qrcode.jpeg" alt="logo" title="董宗磊的博客"></div><div class="footer-top__item"><h3 class="item__title">友情链接</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://mrdear.cn/" title="mrdear" target="_blank">mrdear</a></li><li class="list-item"><a href="https://tech.meituan.com/" title="美团技术团队" target="_blank">美团技术团队</a></li><li class="list-item"><a href="https://coolshell.cn/" title="酷 壳–CoolShell" target="_blank">酷 壳–CoolShell</a></li><li class="list-item"><a href="https://tech.youzan.com/" title="有赞技术团队" target="_blank">有赞技术团队</a></li><li class="list-item"><a href="https://insights.thoughtworks.cn" title="Thoughtworks洞见" target="_blank">Thoughtworks洞见</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">大V博客</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://draveness.me/" title="draveness" target="_blank">draveness</a></li><li class="list-item"><a href="http://www.ruanyifeng.com/home.html" title="阮一峰的个人网站" target="_blank">阮一峰</a></li><li class="list-item"><a href="https://blog.devtang.com/" title="唐巧的博客" target="_blank">唐巧的博客</a></li><li class="list-item"><a href="https://www.hollischuang.com/" title="Hollis" target="_blank">Hollis</a></li><li class="list-item"><a href="http://coder5.cn/" title="武哥漫谈IT" target="_blank">武哥漫谈IT</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">构建工具</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://hexo.io/" title="Blog Framework" target="_blank">Hexo</a></li><li class="list-item"><a href="https://github.com/Mrminfive/hexo-theme-skapp" title="hexo-theme-skapp" target="_blank">hexo-theme-skapp</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2017 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/Mrminfive" target="_blank">minfive</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/dongzl" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:dongzonglei@apache.org" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li><li class="social-network__item"><a href="/atom.xml" target="_blank" title="rss"><i class="iconfont icon-rss"></i></a></li></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script src="/js/md5.min.js"></script><script>var tags=["MySQL","Performance Schema"],gitalk=new Gitalk({clientID:"791785cb3bf7b9b5f1ea",clientSecret:"a73d2380b7dba08575e0190989ef017e480c20c9",repo:"dongzl.github.io",owner:"dongzl",admin:["dongzl"],labels:tags,id:new Date(1676664202e3).getTime()>new Date("2018-02-15").getTime()?md5(location.href):location.href});gitalk.render("comment-container")</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/assets/haruto.model.json"},display:{position:"left",width:150,height:300},mobile:{show:!0},react:{opacity:1},log:!1})</script></body></html>